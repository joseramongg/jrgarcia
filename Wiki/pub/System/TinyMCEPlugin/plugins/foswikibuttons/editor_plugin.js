!function(){"use strict";tinymce.PluginManager.requireLangPack("foswikibuttons"),tinymce.create("tinymce.plugins.FoswikiButtons",{formats_listbox:null,_lastButtonUpdateNode:null,_nodeChangeEventScheduled:null,_deferNodeChangeEvent:null,nodeChangeEventFrequency:null,init:function(t,e){this.formats=t.getParam("foswikibuttons_formats"),this.nodeChangeEventFrequency=t.getParam("foswikibuttons_cursoridletime"),this.format_names=[],this.recipe_names=[],jQuery.each(this.formats,function(e,n){t.plugins.foswikibuttons.format_names.push(e)}),t.onInit.add(function(t){this.plugins.foswikibuttons._registerFormats(t,this.plugins.foswikibuttons.formats),this.plugins.foswikibuttons._contextMenuVerbatimClasses(t)}),this._setupTTButton(t,e),this._setupColourButton(t,e),this._setupAttachButton(t,e),this._setupIndentButton(t,e),this._setupExdentButton(t,e),this._setupHideButton(t,e),this._setupFormatCommand(t,this.formats)},getInfo:function(){return{longname:"Foswiki Buttons Plugin",author:"Crawford Currie",authorurl:"http://c-dot.co.uk",infourl:"http://c-dot.co.uk",version:3}},createControl:function(t,e){return"foswikiformat"===t?this._createFoswikiFormatControl(t,e,this):null},_setupTTButton:function(t,e){t.addCommand("foswikibuttonsTT",function(){t.formatter.toggle("WYSIWYG_TT")}),t.addButton("tt",{title:"foswikibuttons.tt_desc",cmd:"foswikibuttonsTT",image:e+"/img/tt.gif"})},_registerFormats:function(t,e){t.formatter.register("WYSIWYG_TT",{inline:"span",classes:"WYSIWYG_TT"}),t.formatter.register("WYSIWYG_COLOR",[{inline:"span",classes:"WYSIWYG_COLOR",styles:{color:"%value"}},{inline:"span",classes:"WYSIWYG_COLOR"}]),t.formatter.register("IS_WYSIWYG_COLOR",{inline:"span",classes:"WYSIWYG_COLOR"}),t.formatter.register(e)},_createFoswikiFormatControl:function(t,e,n){var o=e.editor;return n.formats_listbox=e.createListBox(t,{title:"Format",onselect:function(t){o.execCommand("foswikibuttonsFormat",!1,t)}}),jQuery.each(n.formats,function(t,e){n.formats_listbox.add(t,t)}),n.formats_listbox.selectByIndex(0),n.formats_listbox},_setupFormatCommand:function(t,e){t.addCommand("foswikibuttonsFormat",function(n,o){jQuery.each(e,function(e,n){t.formatter.remove(e)}),t.formatter.apply(o)}),t.onNodeChange.add(this._nodeChange,this)},_setupColourButton:function(t,e){t.addCommand("foswikibuttonsColour",function(){t.selection.isCollapsed()||t.windowManager.open({location:!1,menubar:!1,toolbar:!1,status:!1,url:e+"/colours.htm",width:220,height:280,movable:!0,popup_css:!1,inline:!0},{plugin_url:e})}),t.addButton("colour",{title:"foswikibuttons.colour_desc",cmd:"foswikibuttonsColour",image:e+"/img/colour.gif"})},_setupAttachButton:function(t,e){t.addCommand("foswikibuttonsAttach",function(){var n="/attach.htm",o=300;null!==FoswikiTiny.foswikiVars.TOPIC.match(/(X{10}|AUTOINC[0-9]+)/)&&(n="/attach_error_autoinc.htm",o=125),t.windowManager.open({location:!1,menubar:!1,toolbar:!1,status:!1,url:e+n,width:450,height:o,movable:!0,inline:!0},{plugin_url:e})}),t.addButton("attach",{title:"foswikibuttons.attach_desc",cmd:"foswikibuttonsAttach",image:e+"/img/attach.gif"})},_setupIndentButton:function(t,e){t.addCommand("fwindent",function(){if(this.queryCommandState("InsertUnorderedList")||this.queryCommandState("InsertOrderedList"))this.execCommand("Indent");else{var e,n=t.dom,o=t.selection,i=n.getParent(o.getStart(),n.isBlock)||n.getParent(o.getEnd(),n.isBlock);if(i){for(e=n.create("div",{class:"foswikiIndent"});i.firstChild;)n.add(e,n.remove(i.firstChild));e=n.add(i,e),t.selection.select(e),t.selection.collapse(),t.selection.setCursorLocation(e,0)}}}),t.addButton("fwindent",{title:"foswikibuttons.indent_desc",cmd:"fwindent",image:e+"/img/indent.gif"})},_setupExdentButton:function(t,e){t.addCommand("fwexdent",function(){var e,n=t.dom,o=t.selection,i=n.getParent(o.getStart(),n.isBlock);if(i&&n.hasClass(i,"foswikiIndent")){for(e=i.parentNode;i.firstChild;)e.insertBefore(n.remove(i.firstChild),i);n.remove(i),t.selection.select(e.firstChild),t.selection.collapse()}else this.execCommand("Outdent")}),t.onNodeChange.add(function(t,e,n,o,i){var s=t.dom,a=t.selection,u=s.getParent(a.getStart(),s.isBlock),r=u&&s.hasClass(u,"foswikiIndent")||t.queryCommandState("Outdent");e.setDisabled("fwexdent",!r)}),t.addButton("fwexdent",{title:"foswikibuttons.exdent_desc",cmd:"fwexdent",image:e+"/img/exdent.gif"})},_setupHideButton:function(t,e){t.addCommand("foswikibuttonsHide",function(){FoswikiTiny.saveEnabled&&(t.getParam("fullscreen_is_enabled")?(t.onGetContent.add(function(){tinymce.DOM.win.setTimeout(function(){var t=tinyMCE.activeEditor;tinyMCE.execCommand("mceToggleEditor",!0,t.id),FoswikiTiny.switchToRaw(t)},10)}),t.execCommand("mceFullScreen")):(tinyMCE.execCommand("mceToggleEditor",!0,t.id),FoswikiTiny.switchToRaw(t)))}),t.addButton("hide",{title:"foswikibuttons.hide_desc",cmd:"foswikibuttonsHide",image:e+"/img/hide.gif"})},_nodeChange:function(t,e,n,o){if("object"==typeof n)return this.nodeChangeEventFrequency?this._scheduleNodeChangeEvent(t,e,n,o):this._doUpdateButtonState(t,e,n,o),!0},_scheduleNodeChangeEvent:function(t,e,n,o){var i=this;this._nodeChangeEventScheduled?this._deferNodeChangeEvent=!0:(this._deferNodeChangeEvent=!1,this._nodeChangeEventScheduled=!0,setTimeout(function(){i._tryNodeChangeEvent(i,t,e,n,o)},this.nodeChangeEventFrequency))},_tryNodeChangeEvent:function(t,e,n,o,i){t._deferNodeChangeEvent?(t._deferNodeChangeEvent=!1,t._nodeChangeEventScheduled=!1,t._scheduleNodeChangeEvent(e,n,o,i)):(t._doUpdateButtonState(e,n),t._nodeChangeEventScheduled=!1)},_doUpdateButtonState:function(t,e){var n,o;t.selection&&(n=t.selection.getNode(),(o=t.selection.isCollapsed())?n!==this._lastButtonUpdateNode&&(this._updateButtonState(t,e,n,o),this._lastButtonUpdateNode=n):this._updateButtonState(t,e))},_updateButtonState:function(t,e,n,o){var i=t.formatter.matchAll(t.plugins.foswikibuttons.format_names),s=e.get(t.id+"_foswikiformat");return o?(e.setDisabled("colour",!0),e.setDisabled("tt",!0)):(e.setDisabled("colour",!1),e.setDisabled("tt",!1)),t.formatter.match("WYSIWYG_TT")?e.setActive("tt",!0):e.setActive("tt",!1),t.formatter.match("WYSIWYG_COLOR")?e.setActive("colour",!0):e.setActive("colour",!1),i.length>0?s.select(i[0]):s.select("Normal"),!0},_contextMenuVerbatimClasses:function(t){var e,n,o,i,s,a,u={},r="";for(t.plugins.foswikibuttons.recipe_names=["bash","cplusplus","csharp","css","delphi","html","java","js","lotusscript","php","sql","tml"],e=0;e<t.plugins.foswikibuttons.recipe_names.length;e+=1)n=t.plugins.foswikibuttons.recipe_names[e],u[n]={block:"pre",remove:"all",classes:"TMLverbatim "+n};t.formatter.register(u),jQuery.each(u,function(e,n){t.plugins.foswikibuttons.recipe_names.push(e)}),t&&t.plugins.contextmenu&&t.plugins.contextmenu.onContextMenu.add(function(e,n,d){i=t.selection,"PRE"===(s=i.getNode()||t.getBody()).nodeName&&-1!==s.className.indexOf("TMLverbatim")&&((a=t.formatter.matchAll(t.plugins.foswikibuttons.recipe_names)).length>0&&(r="("+a[0]+")"),o=n.addMenu({title:"Syntax highlighting"+r}),jQuery.each(u,function(t,e){o.add({title:t,cmd:"foswikiVerbatimClass",value:t})}),o.add({title:"none",cmd:"foswikiVerbatimClass",value:" "}))}),t.addCommand("foswikiVerbatimClass",function(e,n){jQuery.each(u,function(e,n){t.formatter.remove(e)}),n&&t.formatter.apply(n)})}}),tinymce.PluginManager.add("foswikibuttons",tinymce.plugins.FoswikiButtons)}();
