var FoswikiImageDialog={preInit:function(){var e;tinyMCEPopup.requireLangPack(),(e=tinyMCEPopup.getParam("external_image_list_url"))&&document.write('<script language="javascript" type="text/javascript" src="'+tinyMCEPopup.editor.documentBaseURI.toAbsolute(e)+'"><\/script>')},foswikiVars:null,getFoswikiVar:function(name){if(null==this.foswikiVars){var sets=tinyMCEPopup.getWindowArg("vars");this.foswikiVars=eval(sets)}return this.foswikiVars[name]},expandVariables:function(e){this.getFoswikiVar("");for(var t in this.foswikiVars)e=e.replace("%"+t+"%",this.foswikiVars[t],"g");return e},foswikiURL:function(e){if(-1==(e=this.expandVariables(e)).indexOf("/")){e=tinyMCEPopup.getWindowArg("attach_url")+e}return e},init:function(e){var t=document.forms[0],i=t.elements,s=(e=tinyMCEPopup.editor).dom,o=e.selection.getNode();tinyMCEPopup.resizeToInnerSize(),this.fillAttachments(["src_list","over_list","out_list"]),TinyMCE_EditableSelects.init(),"IMG"==o.nodeName&&(i.src.value=s.getAttrib(o,"src"),i.width.value=s.getAttrib(o,"width"),i.height.value=s.getAttrib(o,"height"),i.alt.value=s.getAttrib(o,"alt"),i.title.value=s.getAttrib(o,"title"),i.vspace.value=this.getAttrib(o,"vspace"),i.hspace.value=this.getAttrib(o,"hspace"),i.border.value=this.getAttrib(o,"border"),selectByValue(t,"align",this.getAttrib(o,"align")),selectByValue(t,"class_list",s.getAttrib(o,"class"),!0,!0),i.style.value=s.getAttrib(o,"style"),i.id.value=s.getAttrib(o,"id"),i.dir.value=s.getAttrib(o,"dir"),i.lang.value=s.getAttrib(o,"lang"),i.usemap.value=s.getAttrib(o,"usemap"),i.longdesc.value=s.getAttrib(o,"longdesc"),i.insert.value=e.getLang("update"),/^\s*this.src\s*=\s*\'([^\']+)\';?\s*$/.test(s.getAttrib(o,"onmouseover"))&&(i.onmouseoversrc.value=s.getAttrib(o,"onmouseover").replace(/^\s*this.src\s*=\s*\'([^\']+)\';?\s*$/,"$1")),/^\s*this.src\s*=\s*\'([^\']+)\';?\s*$/.test(s.getAttrib(o,"onmouseout"))&&(i.onmouseoutsrc.value=s.getAttrib(o,"onmouseout").replace(/^\s*this.src\s*=\s*\'([^\']+)\';?\s*$/,"$1")),e.settings.inline_styles&&(s.getAttrib(o,"align")&&this.updateStyle("align"),s.getAttrib(o,"hspace")&&this.updateStyle("hspace"),s.getAttrib(o,"border")&&this.updateStyle("border"),s.getAttrib(o,"vspace")&&this.updateStyle("vspace"))),document.getElementById("srcbrowsercontainer").innerHTML=getBrowserHTML("srcbrowser","src","image","theme_advanced_image"),isVisible("srcbrowser")&&(document.getElementById("src").style.width="260px"),document.getElementById("onmouseoversrccontainer").innerHTML=getBrowserHTML("overbrowser","onmouseoversrc","image","theme_advanced_image"),isVisible("overbrowser")&&(document.getElementById("onmouseoversrc").style.width="260px"),document.getElementById("onmouseoutsrccontainer").innerHTML=getBrowserHTML("outbrowser","onmouseoutsrc","image","theme_advanced_image"),isVisible("outbrowser")&&(document.getElementById("onmouseoutsrc").style.width="260px"),e.getParam("advimage_constrain_proportions",!0)&&(t.constrain.checked=!0),i.onmouseoversrc.value||i.onmouseoutsrc.value?this.setSwapImage(!0):this.setSwapImage(!1),this.changeAppearance(),this.showPreviewImage(i.src.value,1)},insert:function(e,t){var i=tinyMCEPopup.editor;if(""===document.forms[0].src.value)return"IMG"==i.selection.getNode().nodeName&&(i.dom.remove(i.selection.getNode()),i.execCommand("mceRepaint")),void tinyMCEPopup.close();this.insertAndClose()},insertAndClose:function(){var e,t=tinyMCEPopup.editor,i=document.forms[0],s=i.elements,o={};tinyMCEPopup.restoreSelection(),tinymce.isWebKit&&t.getWin().focus(),o=t.settings.inline_styles?{vspace:"",hspace:"",border:"",align:""}:{vspace:s.vspace.value,hspace:s.hspace.value,border:s.border.value,align:getSelectValue(i,"align")},tinymce.extend(o,{src:this.foswikiURL(s.src.value),width:s.width.value,height:s.height.value,alt:s.alt.value,title:s.title.value,class:getSelectValue(i,"class_list"),style:s.style.value,id:s.id.value,dir:s.dir.value,lang:s.lang.value,usemap:s.usemap.value,longdesc:s.longdesc.value}),o.onmouseover=o.onmouseout="",i.onmousemovecheck.checked&&(s.onmouseoversrc.value&&(o.onmouseover="this.src='"+this.foswikiURL(s.onmouseoversrc.value)+"';"),s.onmouseoutsrc.value&&(o.onmouseout="this.src='"+this.foswikiURL(s.onmouseoutsrc.value)+"';")),(e=t.selection.getNode())&&"IMG"==e.nodeName?t.dom.setAttribs(e,o):(t.execCommand("mceInsertContent",!1,'<img id="__mce_tmp" />',{skip_undo:1}),t.dom.setAttribs("__mce_tmp",o),t.dom.setAttrib("__mce_tmp","id",""),t.undoManager.add()),tinyMCEPopup.close()},getAttrib:function(e,t){var i,s,o=tinyMCEPopup.editor,a=o.dom;if(o.settings.inline_styles)switch(t){case"align":if(i=a.getStyle(e,"float"))return i;if(i=a.getStyle(e,"vertical-align"))return i;break;case"hspace":if(i=a.getStyle(e,"margin-left"),s=a.getStyle(e,"margin-right"),i&&i==s)return parseInt(i.replace(/[^0-9]/g,""));break;case"vspace":if(i=a.getStyle(e,"margin-top"),s=a.getStyle(e,"margin-bottom"),i&&i==s)return parseInt(i.replace(/[^0-9]/g,""));break;case"border":if(i=0,tinymce.each(["top","right","bottom","left"],function(t){if(!(t=a.getStyle(e,"border-"+t+"-width"))||t!=i&&0!==i)return i=0,!1;t&&(i=t)}),i)return parseInt(i.replace(/[^0-9]/g,""))}return(i=a.getAttrib(e,t))?i:""},setSwapImage:function(e){var t=document.forms[0];t.onmousemovecheck.checked=e,setBrowserDisabled("overbrowser",!e),setBrowserDisabled("outbrowser",!e),t.over_list&&(t.over_list.disabled=!e),t.out_list&&(t.out_list.disabled=!e),t.onmouseoversrc.disabled=!e,t.onmouseoutsrc.disabled=!e},fillFileList:function(e,t){var i=tinyMCEPopup.dom,s=i.get(e);t=window[t],s.options.length=0,t&&t.length>0?(s.options[s.options.length]=new Option("",""),tinymce.each(t,function(e){s.options[s.options.length]=new Option(e[0],e[1])})):i.remove(i.getParent(e,"tr"))},fillAttachments:function(e){for(var t=new Array,i=0;i<e.length;i++){var s=tinyMCEPopup.dom.get(e[i]);s.options.length=0,t.push(s)}FoswikiTiny.getListOfAttachments(function(i){document.getElementById("attachments_select");for(var s=0;s<i.length;s++)for(var o=0;o<e.length;o++)t[o].options[s+1]=new Option(i[s].name,i[s].name)})},resetImageData:function(){var e=document.forms[0];e.elements.width.value=e.elements.height.value=""},updateImageData:function(e,t){var i=document.forms[0];t||(i.elements.width.value=e.width,i.elements.height.value=e.height),this.preloadImg=e},changeAppearance:function(){var e=tinyMCEPopup.editor,t=document.forms[0],i=document.getElementById("alignSampleImg");i&&(e.getParam("inline_styles")?e.dom.setAttrib(i,"style",t.style.value):(i.align=t.align.value,i.border=t.border.value,i.hspace=t.hspace.value,i.vspace=t.vspace.value))},changeHeight:function(){var e,t=document.forms[0];t.constrain.checked&&this.preloadImg&&""!=t.width.value&&""!=t.height.value&&(e=parseInt(t.width.value)/parseInt(this.preloadImg.width)*this.preloadImg.height,t.height.value=e.toFixed(0))},changeWidth:function(){var e,t=document.forms[0];t.constrain.checked&&this.preloadImg&&""!=t.width.value&&""!=t.height.value&&(e=parseInt(t.height.value)/parseInt(this.preloadImg.height)*this.preloadImg.width,t.width.value=e.toFixed(0))},updateStyle:function(e){var t,i=tinyMCEPopup.dom,s=document.forms[0],o=i.create("img",{style:i.get("style").value});tinyMCEPopup.editor.settings.inline_styles&&("align"==e&&(i.setStyle(o,"float",""),i.setStyle(o,"vertical-align",""),(t=getSelectValue(s,"align"))&&("left"==t||"right"==t?i.setStyle(o,"float",t):o.style.verticalAlign=t)),"border"==e&&(i.setStyle(o,"border",""),((t=s.border.value)||"0"==t)&&(o.style.border="0"==t?"0":t+"px solid black")),"hspace"==e&&(i.setStyle(o,"marginLeft",""),i.setStyle(o,"marginRight",""),(t=s.hspace.value)&&(o.style.marginLeft=t+"px",o.style.marginRight=t+"px")),"vspace"==e&&(i.setStyle(o,"marginTop",""),i.setStyle(o,"marginBottom",""),(t=s.vspace.value)&&(o.style.marginTop=t+"px",o.style.marginBottom=t+"px")),i.get("style").value=i.serializeStyle(i.parseStyle(o.style.cssText)))},changeMouseMove:function(){},showPreviewImage:function(e,t){e?(!t&&tinyMCEPopup.getParam("advimage_update_dimensions_onchange",!0)&&this.resetImageData(),e=this.foswikiURL(e),e=tinyMCEPopup.editor.documentBaseURI.toAbsolute(e),t?tinyMCEPopup.dom.setHTML("prev",'<img id="previewImg" src="'+e+'" border="0" onload="FoswikiImageDialog.updateImageData(this, 1);" />'):tinyMCEPopup.dom.setHTML("prev",'<img id="previewImg" src="'+e+'" border="0" onload="FoswikiImageDialog.updateImageData(this);" onerror="FoswikiImageDialog.resetImageData();" />')):tinyMCEPopup.dom.setHTML("prev","")}};FoswikiImageDialog.preInit(),tinyMCEPopup.onInit.add(FoswikiImageDialog.init,FoswikiImageDialog);
