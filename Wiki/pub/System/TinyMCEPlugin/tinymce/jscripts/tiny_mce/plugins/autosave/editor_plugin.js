!function(e){var t,n="autosave",r="restoredraft",o=e.util.Dispatcher;e.create("tinymce.plugins.AutoSave",{init:function(a,i){function s(e){return((e=/^(\d+)([ms]?)$/.exec(""+e))[2]?{s:1e3,m:6e4}[e[2]]:1)*parseInt(e)}var u=this,g=a.settings;u.editor=a,e.each({ask_before_unload:!0,interval:"30s",retention:"20m",minlength:50},function(e,t){void 0===g[t=n+"_"+t]&&(g[t]=e)}),g.autosave_interval=s(g.autosave_interval),g.autosave_retention=s(g.autosave_retention),a.addButton(r,{title:n+".restore_content",onclick:function(){a.getContent({draft:!0}).replace(/\s|&nbsp;|<\/?p[^>]*>|<br[^>]*>/gi,"").length>0?a.windowManager.confirm(n+".warning_message",function(e){e&&u.restoreDraft()}):u.restoreDraft()}}),a.onNodeChange.add(function(){var e=a.controlManager;e.get(r)&&e.setDisabled(r,!u.hasDraft())}),a.onInit.add(function(){a.controlManager.get(r)&&(u.setupStorage(a),setInterval(function(){a.removed||(u.storeDraft(),a.nodeChanged())},g.autosave_interval))}),u.onStoreDraft=new o(u),u.onRestoreDraft=new o(u),u.onRemoveDraft=new o(u),t||(window.onbeforeunload=e.plugins.AutoSave._beforeUnloadHandler,t=!0)},getInfo:function(){return{longname:"Auto save",author:"Moxiecode Systems AB",authorurl:"http://tinymce.moxiecode.com",infourl:"http://wiki.moxiecode.com/index.php/TinyMCE:Plugins/autosave",version:e.majorVersion+"."+e.minorVersion}},getExpDate:function(){return new Date((new Date).getTime()+this.editor.settings.autosave_retention).toUTCString()},setupStorage:function(t){var r=this,o=n+"_test";r.key=n+t.id,e.each([function(){if(localStorage&&(localStorage.setItem(o,"OK"),"OK"===localStorage.getItem(o)))return localStorage.removeItem(o),localStorage},function(){if(sessionStorage&&(sessionStorage.setItem(o,"OK"),"OK"===sessionStorage.getItem(o)))return sessionStorage.removeItem(o),sessionStorage},function(){if(e.isIE)return t.getElement().style.behavior="url('#default#userData')",{autoExpires:!0,setItem:function(e,n){var o=t.getElement();o.setAttribute(e,n),o.expires=r.getExpDate();try{o.save("TinyMCE")}catch(e){}},getItem:function(e){var n=t.getElement();try{return n.load("TinyMCE"),n.getAttribute(e)}catch(e){return null}},removeItem:function(e){t.getElement().removeAttribute(e)}}}],function(e){try{if(r.storage=e(),r.storage)return!1}catch(e){}})},storeDraft:function(){var e,t,n=this,r=n.storage,o=n.editor;if(r){if(!r.getItem(n.key)&&!o.isDirty())return;(t=o.getContent({draft:!0})).length>o.settings.autosave_minlength&&(e=n.getExpDate(),n.storage.autoExpires||n.storage.setItem(n.key+"_expires",e),n.storage.setItem(n.key,t),n.onStoreDraft.dispatch(n,{expires:e,content:t}))}},restoreDraft:function(){var e,t=this.storage;t&&(e=t.getItem(this.key))&&(this.editor.setContent(e),this.onRestoreDraft.dispatch(this,{content:e}))},hasDraft:function(){var e,t=this.storage;if(t&&!!t.getItem(this.key)){if(this.storage.autoExpires)return!0;if(e=new Date(t.getItem(this.key+"_expires")),(new Date).getTime()<e.getTime())return!0;this.removeDraft()}return!1},removeDraft:function(){var e,t=this.storage,n=this.key;t&&(e=t.getItem(n),t.removeItem(n),t.removeItem(n+"_expires"),e&&this.onRemoveDraft.dispatch(this,{content:e}))},static:{_beforeUnloadHandler:function(t){var n;return e.each(tinyMCE.editors,function(e){e.plugins.autosave&&e.plugins.autosave.storeDraft(),e.getParam("fullscreen_is_enabled")||!n&&e.isDirty()&&e.getParam("autosave_ask_before_unload")&&(n=e.getLang("autosave.unload_msg"))}),n}}}),e.PluginManager.add("autosave",e.plugins.AutoSave)}(tinymce);
