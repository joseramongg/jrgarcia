!function(){var e=tinymce.util.JSONRequest,t=tinymce.each,n=tinymce.DOM;tinymce.create("tinymce.plugins.SpellcheckerPlugin",{getInfo:function(){return{longname:"Spellchecker",author:"Moxiecode Systems AB",authorurl:"http://tinymce.moxiecode.com",infourl:"http://wiki.moxiecode.com/index.php/TinyMCE:Plugins/spellchecker",version:tinymce.majorVersion+"."+tinymce.minorVersion}},init:function(e,n){var s=this;if(s.url=n,s.editor=e,s.rpcUrl=e.getParam("spellchecker_rpc_url","{backend}"),"{backend}"==s.rpcUrl){if(tinymce.isIE)return;s.hasSupport=!0,e.onContextMenu.addToTop(function(e,t){if(s.active)return!1})}e.addCommand("mceSpellCheck",function(){"{backend}"!=s.rpcUrl?s.active?s._done():(e.setProgressState(1),s._sendRPC("checkWords",[s.selectedLang,s._getWords()],function(t){t.length>0?(s.active=1,s._markWords(t),e.setProgressState(0),e.nodeChanged()):(e.setProgressState(0),e.getParam("spellchecker_report_no_misspellings",!0)&&e.windowManager.alert("spellchecker.no_mpell"))})):s.editor.getBody().spellcheck=s.active=!s.active}),!1!==e.settings.content_css&&e.contentCSS.push(n+"/css/content.css"),e.onClick.add(s._showMenu,s),e.onContextMenu.add(s._showMenu,s),e.onBeforeGetContent.add(function(){s.active&&s._removeWords()}),e.onNodeChange.add(function(e,t){t.setActive("spellchecker",s.active)}),e.onSetContent.add(function(){s._done()}),e.onBeforeGetContent.add(function(){s._done()}),e.onBeforeExecCommand.add(function(e,t){"mceFullScreen"==t&&s._done()}),s.languages={},t(e.getParam("spellchecker_languages","+English=en,Danish=da,Dutch=nl,Finnish=fi,French=fr,German=de,Italian=it,Polish=pl,Portuguese=pt,Spanish=es,Swedish=sv","hash"),function(e,t){0===t.indexOf("+")&&(t=t.substring(1),s.selectedLang=e),s.languages[t]=e})},createControl:function(e,n){var s,c=this;c.editor;if("spellchecker"==e)return"{backend}"==c.rpcUrl?(c.hasSupport&&(s=n.createButton(e,{title:"spellchecker.desc",cmd:"mceSpellCheck",scope:c})),s):((s=n.createSplitButton(e,{title:"spellchecker.desc",cmd:"mceSpellCheck",scope:c})).onRenderMenu.add(function(e,n){n.add({title:"spellchecker.langs",class:"mceMenuItemTitle"}).setDisabled(1),c.menuItems={},t(c.languages,function(e,t){var s,r={icon:1};r.onclick=function(){e!=c.selectedLang&&(c._updateMenu(s),c.selectedLang=e)},r.title=t,(s=n.add(r)).setSelected(e==c.selectedLang),c.menuItems[e]=s,e==c.selectedLang&&(c.selectedItem=s)})}),s)},setLanguage:function(e){if(e!=this.selectedLang){if(0===tinymce.grep(this.languages,function(t){return t===e}).length)throw"Unknown language: "+e;this.selectedLang=e,this.menuItems&&this._updateMenu(this.menuItems[e]),this.active&&this._done()}},_updateMenu:function(e){e.setSelected(1),this.selectedItem.setSelected(0),this.selectedItem=e},_walk:function(e,t){var n,s=this.editor.getDoc();if(s.createTreeWalker)for(n=s.createTreeWalker(e,NodeFilter.SHOW_TEXT,null,!1);null!=(e=n.nextNode());)t.call(this,e);else tinymce.walk(e,t,"childNodes")},_getSeparators:function(){var e,t="",n=this.editor.getParam("spellchecker_word_separator_chars",'\\s!"#$%&()*+,-./:;<=>?@[]^_{|}����������������”“');for(e=0;e<n.length;e++)t+="\\"+n.charAt(e);return t},_getWords:function(){var e=this.editor,n=[],s="",c={},r=[];return this._walk(e.getBody(),function(e){3==e.nodeType&&(s+=e.nodeValue+" ")}),e.getParam("spellchecker_word_pattern")?r=s.match("("+e.getParam("spellchecker_word_pattern")+")","gi"):(s=s.replace(new RegExp("([0-9]|["+this._getSeparators()+"])","g")," "),r=(s=tinymce.trim(s.replace(/(\s+)/g," "))).split(" ")),t(r,function(e){c[e]||(n.push(e),c[e]=1)}),n},_removeWords:function(e){var n=this.editor,s=n.dom,c=n.selection,r=c.getRng(!0);t(s.select("span").reverse(),function(t){t&&(s.hasClass(t,"mceItemHiddenSpellWord")||s.hasClass(t,"mceItemHidden"))&&(e&&s.decode(t.innerHTML)!=e||s.remove(t,1))}),c.setRng(r)},_markWords:function(e){var n=this.editor,s=n.dom,c=n.getDoc(),r=n.selection,o=r.getRng(!0),i=[],a=e.join("|"),l=this._getSeparators(),d=new RegExp("(^|["+l+"])("+a+")(?=["+l+"]|$)","g");this._walk(n.getBody(),function(e){3==e.nodeType&&i.push(e)}),t(i,function(e){var t,n,r,o,i=e.nodeValue;if(d.lastIndex=0,d.test(i)){if(i=s.encode(i),n=s.create("span",{class:"mceItemHidden"}),tinymce.isIE){for(i=i.replace(d,"$1<mcespell>$2</mcespell>");-1!=(o=i.indexOf("<mcespell>"));)(r=i.substring(0,o)).length&&(t=c.createTextNode(s.decode(r)),n.appendChild(t)),o=(i=i.substring(o+10)).indexOf("</mcespell>"),r=i.substring(0,o),i=i.substring(o+11),n.appendChild(s.create("span",{class:"mceItemHiddenSpellWord"},r));i.length&&(t=c.createTextNode(s.decode(i)),n.appendChild(t))}else n.innerHTML=i.replace(d,'$1<span class="mceItemHiddenSpellWord">$2</span>');s.replace(n,e)}}),r.setRng(o)},_showMenu:function(e,s){var c,r=this,o=(e=r.editor,r._menu),i=e.dom,a=i.getViewPort(e.getWin()),l=s.target;if(s=0,o||(o=e.controlManager.createDropMenu("spellcheckermenu",{class:"mceNoIcons"}),r._menu=o),i.hasClass(l,"mceItemHiddenSpellWord"))return o.removeAll(),o.add({title:"spellchecker.wait",class:"mceMenuItemTitle"}).setDisabled(1),r._sendRPC("getSuggestions",[r.selectedLang,i.decode(l.innerHTML)],function(n){var s;o.removeAll(),n.length>0?(o.add({title:"spellchecker.sug",class:"mceMenuItemTitle"}).setDisabled(1),t(n,function(t){o.add({title:t,onclick:function(){i.replace(e.getDoc().createTextNode(t),l),r._checkDone()}})}),o.addSeparator()):o.add({title:"spellchecker.no_sug",class:"mceMenuItemTitle"}).setDisabled(1),e.getParam("show_ignore_words",!0)&&(s=r.editor.getParam("spellchecker_enable_ignore_rpc",""),o.add({title:"spellchecker.ignore_word",onclick:function(){var t=l.innerHTML;i.remove(l,1),r._checkDone(),s&&(e.setProgressState(1),r._sendRPC("ignoreWord",[r.selectedLang,t],function(t){e.setProgressState(0)}))}}),o.add({title:"spellchecker.ignore_words",onclick:function(){var t=l.innerHTML;r._removeWords(i.decode(t)),r._checkDone(),s&&(e.setProgressState(1),r._sendRPC("ignoreWords",[r.selectedLang,t],function(t){e.setProgressState(0)}))}})),r.editor.getParam("spellchecker_enable_learn_rpc")&&o.add({title:"spellchecker.learn_word",onclick:function(){var t=l.innerHTML;i.remove(l,1),r._checkDone(),e.setProgressState(1),r._sendRPC("learnWord",[r.selectedLang,t],function(t){e.setProgressState(0)})}}),o.update()}),c=n.getPos(e.getContentAreaContainer()),o.settings.offset_x=c.x,o.settings.offset_y=c.y,e.selection.select(l),c=i.getPos(l),o.showMenu(c.x,c.y+l.offsetHeight-a.y),tinymce.dom.Event.cancel(s);o.hideMenu()},_checkDone:function(){var e,n=this.editor.dom;t(n.select("span"),function(t){if(t&&n.hasClass(t,"mceItemHiddenSpellWord"))return e=!0,!1}),e||this._done()},_done:function(){var e=this.active;this.active&&(this.active=0,this._removeWords(),this._menu&&this._menu.hideMenu(),e&&this.editor.nodeChanged())},_sendRPC:function(t,n,s){var c=this;e.sendRPC({url:c.rpcUrl,method:t,params:n,success:s,error:function(e,t){c.editor.setProgressState(0),c.editor.windowManager.alert(e.errstr||"Error response: "+t.responseText)}})}}),tinymce.PluginManager.add("spellchecker",tinymce.plugins.SpellcheckerPlugin)}();
