!function($){var instrument,editing_element;$.editable&&($.editable.addInputType("datepicker",{element:function(e,t){var a=$("<input>");return"none"!=e.width&&a.width(e.width),"none"!=e.height&&a.height(e.height),a.prop("autocomplete",!1),$(this).append(a),a},plugin:function(e,t){var a=this;e.onblur="ignore";var n=$(this).find("input"),i=new Calendar(1,null,function(e,t){e.dateClicked&&(e.hide(),n.val(t),$(a).trigger("submit"))},function(n){n.hide(),t.reset.apply(t,[a]),$(t).addClass(e.cssdecoration)});i.showsOtherMonths=!0,i.setRange(1900,2070),i.create(),e.format&&(i.showsTime=-1!=e.format.search(/%H|%I|%k|%l|%M|%p|%P/),i.setDateFormat(e.format),i.setTtDateFormat(e.format)),i.parseDate(t.revert.replace(/^\s+/,"")),i.showAtElement(n[0],"Br")}}),$.editable.addInputType("radio",{element:function(e,t){var a=$('<input type="hidden" id="'+e.name+'" name="'+e.name+'" value="" />');$(this).append(a);var n,i,r,o,d=1;for(n in e.data)o=e.name+"_button"+d,$(this).append('<label for="'+o+'">'+e.data[n]+"</label>"),r=n===e.text?' checked="checked"':"",i=$('<input type="radio" name="'+e.name+'_buttons" id="'+o+'"'+r+' value="'+n+'" />'),$(this).append(i),i.click(function(){$("#"+e.name).val($(this).val())}),d++;return a}}),$.editable.addInputType("erpselect",{element:function(e,t){var a=$("<select />");return $(this).append(a),a},content:function(data,settings,original){if(console.debug("content"),String==data.constructor)eval("var json = "+data);else var json=data;for(var i in json.order){var key=json.order[i];if(null!=json.keys[key]){var option=$("<option />").val(key).append(json.keys[key]);$("select",this).append(option)}}$("select",this).children().each(function(){$(this).val()!=json.selected&&$(this).text()!=$.trim(original.revert)||$(this).prop("selected",!0)})}}),$.editable.addInputType("checkbox",{element:function(e,t){var a=$('<input type="hidden" id="'+e.name+'" name="'+e.name+'" value="" />');$(this).append(a);var n,i,r,o,d=1,s=new RegExp("\\b("+e.text.replace(/\s*,\s*/,"|")+")\\b");for(n in e.data)o=e.name+"_button"+d,r=s.test(n)?' checked="checked"':"",i=$('<input type="checkbox" name="'+e.name+'_buttons" id="'+o+'"'+r+' value="'+n+'" />'),$(this).append(i),$(this).append('<label for="'+o+'">'+e.data[n]+"</label>"),i.change(function(){var t='input[name="'+e.name+'_buttons"]',a=[];$(t).each(function(e,t){$(t).attr("checked")&&a.push($(t).val())}),$("#"+e.name).val(a.join(","))}),d++;return a}}));var onDrop=function(e,t,a,n){var i,r=$(e.target);if(r.hasClass("drag-helper")){var o=n.first().offset().top,d=e.pageY-o;i=d<(n.last().offset().top()+n.last().height()-o)/2?"top":"bottom",r="top"==i?n.first():n.last()}else{d=e.pageY-r.offset().top;i=d<r.height()/2?"top":"bottom"}var s,l=r.data("erp-data"),c=a.data("erp-data").row;s=null!=l?l.row:r.next().size()>0?0:r.parent().children().size();var p=t.closest("table"),f=$.extend({noredirect:1},l);if($.each(p.data("erp-data"),function(e,t){f["erp_"+e]=t}),"bottom"==i&&s++,s!=c){a.fadeTo("slow",0),t.css("cursor","wait"),f.erp_action="moveRowCmd",f.old_pos=c,f.new_pos=s,null==f.erp_row&&(f.erp_row=c),f.erp_stop_edit=1,$('input[name="validation_key"]').first().each(function(){var e=$(this);e.closest("form").each(function(){"undefined"!=typeof StrikeOne&&StrikeOne.submit(this)}),f.validation_key=e.val()}),p.css("cursor","wait");var u=p.attr("id");u||(u="table"+Date.now(),p.attr("id",u)),$.ajax({url:foswiki.getPreference("SCRIPTURLPATH")+"/rest/EditRowPlugin/save",type:"POST",data:f,success:function(e){var n=$("#"+u);if(0!=e.indexOf("RESPONSE"))t.replaceWith($(e).find("form[name='loginform']")),$("form[name='loginform'] input[name='noredirect']").remove();else{var o=$(e.replace(/^RESPONSE/,""));o.addClass("erp_new_table"),n.replaceWith(o),$(document).find(".erp_new_table").each(function(e,t){$(this).removeClass("erp_new_table"),instrument($(this))})}"top"==i?a.insertBefore(r):a.insertAfter(r),n.css("cursor","auto")},error:function(e,t,n){a.fadeTo("fast",1),$("#"+u).css("cursor","auto");var i=e.responseText;i=i&&0==i.indexOf("RESPONSE")?i.replace(/^RESPONSE/,": "):"",alert("Error "+e.status+" - Failed to move row"+i)}})}},dragHelper=function(e){var t=e.clone();return $("<div><table></table></div>").find("table").append(t.addClass("drag-helper")).end()},makeRowDraggable=function(e){var t=e.closest("thead,tbody,tfoot,table");e.find("td, th").first().each(function(){var a=$("<a href='#' class='erp_drag_button ui-icon-arrow-2-n-s ui-icon' title='Click and drag to move row'>move</a>"),n=$("<div class='erpJS_container' style='display: inline-block; width: 0em;'></div>");n.append(a),$(this).prepend(n),a.draggable({containment:t,axis:"y",appendTo:t,helper:function(t){return dragHelper(e)},start:function(a,n){e.fadeTo("fast",.3);var i=t.find("tr");i.not(e).not(".drag-helper").droppable({drop:function(a,n){onDrop(a,t,e,i)}})},stop:function(){e.fadeTo("fast",1)}})})},editControls={onedit:function(e,t){$(t).next().hide()},submitdata:function(e,t){var a=$.extend({action:"saveCellCmd"},$(this).data("erp-data"),$(this).closest("tr").data("erp-data"),$(this).closest("table").data("erp-data")),n={};return $.each(a,function(e,t){n["erp_"+e]=t}),n.noredirect=1,$(this).closest("form").each(function(){"undefined"!=typeof StrikeOne&&StrikeOne.submit(this),$(this).find('input[name="validation_key"]').each(function(){n.validation_key=$(this).val()})}),n},onsubmit:function(e,t){return!t.isSubmitting&&(t.isSubmitting=!0,$("<div class='erp-clock'></div>").insertAfter($(t).next()),!0)},onreset:function(e,t){return $(t).next().show(),!0},onerror:function(e,t,a){var n=a.responseText;t.isSubmitting=!1,$(t).parent().find(".erp-clock").remove(),$(t).next().show(),0==n.indexOf("RESPONSE")&&alert(n.replace(/^RESPONSE/,""))},onblur:"cancel"},editCallback=function(e,t,a,n){t=t.replace(/^RESPONSE/,""),$(e).html(t),n&&(a.data=t),e.isSubmitting=!1,$(e).parent().find(".erp-clock").remove(),$(e).next().show()},textCallback=function(e,t){editCallback(this,e,t,!0)},otherCallback=function(e,t){editCallback(this,e,t,!1)},onSaveComplete=function(e,t){var a=e.getResponseHeader("X-Foswiki-Validation");a&&$("input[name='validation_key']").each(function(){$(this).val("?"+a)}),"success"!=t&&alert(e.responseText)},attachJEditable=function(e){var t=e.data("erp-data");if(t&&t.type&&"label"!=t.type){var a=$("<div class='erpJS_container'></div>"),n=$('<div class="erp-edit-button" title="Click to edit"></div>');a.append(n),e.closest("td, th").prepend(a),n.click(function(){editing_element=e,e.triggerHandler("erp_edit")}),t=$.extend({event:"erp_edit",placeholder:'<div class="erp_empty"></div>',callback:"text"==t.type||"textarea"==t.type?textCallback:otherCallback,tooltip:"",ajaxoptions:{complete:onSaveComplete}},t,editControls);var i=foswiki.getPreference("SCRIPTURLPATH")+"/rest/EditRowPlugin/save";e.editable&&e.editable(i,t)}},erp_dataDirty=!1,erp_dirtyVeto=!1,repair_table=function(e,t){var a,n;if(t){void 0!==t.headerrows?a=t.headerrows:t.TABLE&&void 0!==t.TABLE.headerrows&&(a=t.TABLE.headerrows),void 0!==t.footerrows?n=t.footerrows:t.TABLE&&void 0!==t.TABLE.footerrows&&(n=t.TABLE.footerrows);var i=e.children("tbody");if(0!==i.length){if(a>0){var r=e.children("thead");for(0===r.length&&(r=$("<thead></thead>")).prependTo(e);r.children().length<a;)if(i.children().length>0)i.children().first().detach().appendTo(r);else{if(!(o.children().length>0))break;o.children().first().detach().appendTo(r)}}if(n>0){var o=e.children("tfoot");for(0===o.length&&(o=$("<tfoot></tfoot>")).appendTo(e);o.children().length<n&&i.children().length>0;)i.children().last().detach().prependTo(o)}}}};instrument=function(e){e.find(".erpJS_cell").each(function(){var e=$(this).data("erp-tabledata");if(e){var t=$(this).closest("table");t.data("erp-data",e),repair_table(t,e),t.addClass("erp_editable")}if(e=$(this).data("erp-trdata")){var a=$(this).closest("tr");a.data("erp-data",e),a.addClass("ui-draggable")}}),e.find(".interactive_sort").first().each(function(){var e=$(this).data("sort");$(this).closest("table").data("sort",e).find(".tableSortIcon").remove()}),e.find(".erpJS_input").change(function(){erp_dataDirty=!0}),e.find("a.erpJS_willDiscard").click(function(e){return!(erp_dataDirty&&!confirm("This action will discard your changes."))||(erp_dirtyVeto=!0,!1)}),(!$.browser.msie||parseInt($.browser.version)>=8)&&e.find("a.erpJS_submit").button(),e.find("a.erpJS_submit").click(function(){var e=!0;if(erp_dirtyVeto)erp_dirtyVeto=!1,e=!1;else{var t=$(this).closest("form");t&&t.length>0&&(t[0].erp_action.value=$(this).attr("href"),t.submit(),e=!1)}return e}),$(".interactive_sort",e).click(function(){return sortTable(this,$(this).data("sort")),!1}).each(function(){$(this).addClass("erpJS_sort")}),$("table.erp_editable",e).find(".foswikiSortedCol").find(".interactive_sort").each(function(){var e=$(this);e.parent("a").each(function(){e.unwrap()});e.closest("table").find(".tableSortIcon").remove();var t=e.data("sort");$("<div></div>").addClass("tableSortIcon ui-icon erp-button ui-icon-circle-triangle-"+(t&&1==t.reverse?"s":"n")).attr("title","Sorted "+(t&&1==t.reverse?"descending":"ascending")).appendTo(e.closest("td,th"))});var t=null;$(".ui-draggable").mouseover(function(e){var a=$(this);a.is(".erp_instrumented")||(a.addClass("erp_instrumented"),a.closest("tbody,table").children().length>1&&makeRowDraggable(a),a.find(".erpJS_cell").each(function(e,t){attachJEditable($(this))})),t&&a[0]==t[0]||(t&&t.find(".erpJS_container").fadeOut("fast"),a.find(".erp_drag_button,.erpJS_container").fadeIn("fast"),t=a)})},$.ajaxSetup({error:function(e,t,a){401==e.status&&alert("Please log in before editing")}}),$(function(){instrument($(document))}),$(window).load(function(){var e=$(".erp-edittable"),t=$(e).parent(),a=$(t).attr("href");$(e).click(function(){window.location.assign(a)})})}(jQuery);
