!function(e){e.fn.extend({autocomplete:function(t,n){var a="string"==typeof t;return n=e.extend({},e.Autocompleter.defaults,{url:a?t:null,data:a?null:t,delay:a?e.Autocompleter.defaults.delay:10,max:n&&!n.scroll?10:150},n),n.highlight=n.highlight||function(e){return e},n.formatMatch=n.formatMatch||n.formatItem,this.each(function(){new e.Autocompleter(this,n)})},result:function(e){return this.bind("result",e)},search:function(e){return this.trigger("search",[e])},flushCache:function(){return this.trigger("flushCache")},setOptions:function(e){return this.trigger("setOptions",[e])},unautocomplete:function(){return this.trigger("unautocomplete")}}),e.Autocompleter=function(t,n){function a(){var a=T.selected();if(!a)return!1;var i=a.result;if(g=i,n.multiple){var o=r(v.val());if(o.length>1){var s,u=n.multipleSeparator.length,c=e(t).selection().start,f=0;e.each(o,function(e,t){if(f+=t.length,c<=f)return s=e,!1;f+=u}),o[s]=i,i=o.join(n.multipleSeparator)}i+=n.multipleSeparator}return v.val(i),l(),v.trigger("result",[a.data,a.value]),!0}function i(e,t){if(p!=f.DEL){var a=v.val();(t||a!=g)&&(g=a,(a=o(a)).length>=n.minChars?(v.addClass(n.loadingClass),n.matchCase||(a=a.toLowerCase()),u(a,s,l)):(c(),T.hide()))}else T.hide()}function r(t){return t?n.multiple?e.map(t.split(n.multipleSeparator),function(n){return e.trim(t).length?e.trim(n):null}):[e.trim(t)]:[""]}function o(a){if(!n.multiple)return a;var i=r(a);if(1==i.length)return i[0];var o=e(t).selection().start;return(i=o==a.length?r(a):r(a.replace(a.substring(o),"")))[i.length-1]}function l(){T.visible();T.hide(),clearTimeout(d),c(),n.mustMatch&&v.search(function(e){if(!e)if(n.multiple){var t=r(v.val()).slice(0,-1);v.val(t.join(n.multipleSeparator)+(t.length?n.multipleSeparator:""))}else v.val(""),v.trigger("result",null)})}function s(a,i){i&&i.length&&w?(c(),T.display(i,a),function(a,i){n.autoFill&&o(v.val()).toLowerCase()==a.toLowerCase()&&p!=f.BACKSPACE&&(v.val(v.val()+i.substring(o(g).length)),e(t).selection(g.length,g.length+i.length))}(a,i[0].value),T.show()):l()}function u(a,i,r){n.matchCase||(a=a.toLowerCase());var l=C.load(a);if(l&&l.length)i(a,l);else if("string"==typeof n.url&&n.url.length>0){var s={timestamp:+new Date};e.each(n.extraParams,function(e,t){s[e]="function"==typeof t?t(v):t}),e.ajax({mode:"abort",port:"autocomplete"+t.name,dataType:n.dataType,url:n.url,data:e.extend({q:o(a),limit:n.max},s),success:function(t){var r=n.parse&&n.parse(t)||function(t){for(var a=[],i=t.split("\n"),r=0;r<i.length;r++){var o=e.trim(i[r]);o&&(o=o.split("|"),a[a.length]={data:o,value:o[0],result:n.formatResult&&n.formatResult(o,o[0])||o[0]})}return a}(t);C.add(a,r),i(a,r)}})}else T.emptyList(),null!=h?h():r(a)}function c(){v.removeClass(n.loadingClass)}var f={UP:38,DOWN:40,DEL:46,TAB:9,RETURN:13,ESC:27,COMMA:188,PAGEUP:33,PAGEDOWN:34,BACKSPACE:8},h=null;null!=n.failure&&"function"==typeof n.failure&&(h=n.failure);var d,p,m,v=e(t).attr("autocomplete","off").addClass(n.inputClass),g="",C=e.Autocompleter.Cache(n),w=0,b={mouseDownOnSelect:!1},T=e.Autocompleter.Select(n,t,a,b);v.wrap("<div style='position:relative; display:inline; white-space:nowrap'></div>");var A=e("<span class='ac_spinner' />").insertAfter(v);window.setTimeout(function(){var e=parseInt(v.css("margin-right"),10)||0;A.css({"margin-left":-20-e})},500),e.browser.opera&&e(t.form).bind("submit.autocomplete",function(){if(m)return m=!1,!1}),v.bind((e.browser.opera?"keypress":"keydown")+".autocomplete",function(t){switch(w=1,p=t.keyCode,t.keyCode){case f.UP:T.visible()?(t.preventDefault(),T.prev()):i(0,!0);break;case f.DOWN:T.visible()?(t.preventDefault(),T.next()):i(0,!0);break;case f.PAGEUP:T.visible()?(t.preventDefault(),T.pageUp()):i(0,!0);break;case f.PAGEDOWN:T.visible()?(t.preventDefault(),T.pageDown()):i(0,!0);break;case n.multiple&&","==e.trim(n.multipleSeparator)&&f.COMMA:case f.TAB:case f.RETURN:if(a())return t.preventDefault(),m=!0,!1;break;case f.ESC:T.hide();break;default:clearTimeout(d),d=window.setTimeout(i,n.delay)}}).focus(function(){w++}).blur(function(){w=0,b.mouseDownOnSelect||(clearTimeout(d),d=setTimeout(l,200))}).click(function(){n.clickFire?T.visible()||i(0,!0):w++>1&&!T.visible()&&i(0,!0)}).bind("search",function(){function t(e,t){var a;if(t&&t.length)for(var i=0;i<t.length;i++)if(t[i].result.toLowerCase()==e.toLowerCase()){a=t[i];break}"function"==typeof n?n(a):v.trigger("result",a&&[a.data,a.value])}var n=arguments.length>1?arguments[1]:null;e.each(r(v.val()),function(e,n){u(n,t,t)})}).bind("flushCache",function(){C.flush()}).bind("setOptions",function(){e.extend(!0,n,arguments[1]),"data"in arguments[1]&&C.populate()}).bind("unautocomplete",function(){T.unbind(),v.unbind(),e(t.form).unbind(".autocomplete")})},e.Autocompleter.defaults={inputClass:"ac_input",resultsClass:"ac_results",loadingClass:"ac_loading",minChars:1,delay:400,matchCase:!1,matchSubset:!0,matchContains:!1,cacheLength:100,max:1e3,mustMatch:!1,extraParams:{},selectFirst:!0,formatItem:function(e){return e[0]},formatMatch:null,autoFill:!1,width:0,multiple:!1,multipleSeparator:" ",inputFocus:!0,clickFire:!1,highlight:function(e,t){return e.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)("+t.replace(/([\^\$\(\)\[\]\{\}\*\.\+\?\|\\])/gi,"\\$1")+")(?![^<>]*>)(?![^&;]+;)","gi"),"<strong>$1</strong>")},scroll:!0,scrollHeight:180,scrollJumpPosition:!0},e.Autocompleter.Cache=function(t){function n(e,n){t.matchCase||(e=e.toLowerCase());var a=e.indexOf(n);return"word"==t.matchContains&&(a=e.toLowerCase().search("\\b"+n.toLowerCase())),-1!=a&&(0==a||t.matchContains)}function a(e,n){l>t.cacheLength&&r(),o[e]||l++,o[e]=n}function i(){if(!t.data)return!1;var n={},i=0;t.url||(t.cacheLength=1),n[""]=[];for(var r=0,o=t.data.length;r<o;r++){var l=t.data[r];l="string"==typeof l?[l]:l;var s=t.formatMatch(l,r+1,t.data.length);if(!1!==s){var u=s.charAt(0).toLowerCase();n[u]||(n[u]=[]);var c={value:s,data:l,result:t.formatResult&&t.formatResult(l)||s};n[u].push(c),i++<t.max&&n[""].push(c)}}e.each(n,function(e,n){t.cacheLength++,a(e,n)})}function r(){o={},l=0}var o={},l=0;return setTimeout(i,25),{flush:r,add:a,populate:i,load:function(a){if(!t.cacheLength||!l)return null;if(!t.url&&t.matchContains){var i=[];for(var r in o)if(r.length>0){var s=o[r];e.each(s,function(e,t){n(t.value,a)&&i.push(t)})}return i}if(o[a])return o[a];if(t.matchSubset)for(var u=a.length-1;u>=t.minChars;u--){if(s=o[a.substr(0,u)]){i=[];return e.each(s,function(e,t){n(t.value,a)&&(i[i.length]=t)}),i}}return null}}},e.Autocompleter.Select=function(t,n,a,i){function r(e){for(var t=e.target;t&&"LI"!=t.tagName;)t=t.parentNode;return t||[]}function o(e){s.slice(d,d+1).removeClass(h.ACTIVE),function(e){(t.scrollJumpPosition||!t.scrollJumpPosition&&!(e<0&&0==d||e>0&&d==s.size()-1))&&((d+=e)<0?d=s.size()-1:d>=s.size()&&(d=0))}(e);var n=s.slice(d,d+1).addClass(h.ACTIVE);if(t.scroll){var a=0;s.slice(0,d).each(function(){a+=this.offsetHeight}),a+n[0].offsetHeight-f.scrollTop()>f[0].clientHeight?f.scrollTop(a+n[0].offsetHeight-f.innerHeight()):a<f.scrollTop()&&f.scrollTop(a)}}function l(){f.empty();for(var n=function(e){return t.max&&t.max<e?t.max:e}(u.length),a=0;a<n;a++)if(u[a]){var i=t.formatItem(u[a].data,a+1,n,u[a].value,p);if(!1!==i){var r=e("<li/>").html(t.highlight(i,p)).addClass(a%2==0?"ac_even":"ac_odd").appendTo(f)[0];e.data(r,"ac_data",u[a])}}s=f.find("li"),t.selectFirst&&(s.slice(0,1).addClass(h.ACTIVE),d=0),e.fn.bgiframe&&f.bgiframe()}var s,u,c,f,h={ACTIVE:"ac_over"},d=-1,p="",m=!0;return{display:function(o,s){m&&(c=e("<div/>").hide().addClass(t.resultsClass).css("position","absolute").appendTo(document.body).hover(function(t){e(this).is(":visible")&&n.focus(),i.mouseDownOnSelect=!1}),f=e("<ul/>").appendTo(c).mouseover(function(t){r(t).nodeName&&"LI"==r(t).nodeName.toUpperCase()&&(d=e("li",f).removeClass(h.ACTIVE).index(r(t)),e(r(t)).addClass(h.ACTIVE))}).click(function(i){return e(r(i)).addClass(h.ACTIVE),a(),t.inputFocus&&n.focus(),!1}).mousedown(function(){i.mouseDownOnSelect=!0}).mouseup(function(){i.mouseDownOnSelect=!1}),t.width>0&&c.css("width",t.width),m=!1),u=o,p=s,l()},next:function(){o(1)},prev:function(){o(-1)},pageUp:function(){o(0!=d&&d-8<0?-d:-8)},pageDown:function(){d!=s.size()-1&&d+8>s.size()?o(s.size()-1-d):o(8)},hide:function(){c&&c.hide(),s&&s.removeClass(h.ACTIVE),d=-1},visible:function(){return c&&c.is(":visible")},current:function(){return this.visible()&&(s.filter("."+h.ACTIVE)[0]||t.selectFirst&&s[0])},show:function(){var a=e(n).offset();if(c.css({width:"string"==typeof t.width||t.width>0?t.width:e(n).width(),top:a.top+n.offsetHeight,left:a.left}).show(),t.scroll&&(f.scrollTop(0),f.css({maxHeight:t.scrollHeight,overflow:"auto"}),e.browser.msie&&void 0===document.body.style.maxHeight)){var i=0;s.each(function(){i+=this.offsetHeight});var r=i>t.scrollHeight;f.css("height",r?t.scrollHeight:i),r||s.width(f.width()-parseInt(s.css("padding-left"))-parseInt(s.css("padding-right")))}},selected:function(){var t=s&&s.filter("."+h.ACTIVE).removeClass(h.ACTIVE);return t&&t.length&&e.data(t[0],"ac_data")},emptyList:function(){f&&f.empty()},unbind:function(){c&&c.remove()}}},e.fn.selection=function(e,t){if(void 0!==e)return this.each(function(){if(this.createTextRange){var n=this.createTextRange();void 0===t||e==t?(n.move("character",e),n.select()):(n.collapse(!0),n.moveStart("character",e),n.moveEnd("character",t),n.select())}else this.setSelectionRange?this.setSelectionRange(e,t):this.selectionStart&&(this.selectionStart=e,this.selectionEnd=t)});var n=this[0];if(n.createTextRange){var a=document.selection.createRange(),i=n.value,r=a.text.length;a.text="<->";var o=n.value.indexOf("<->");return n.value=i,this.selection(o,o+r),{start:o,end:o+r}}return void 0!==n.selectionStart?{start:n.selectionStart,end:n.selectionEnd}:void 0}}(jQuery);
