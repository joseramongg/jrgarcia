!function(e){e.fn.extend({textboxlist:function(t){var l=e.extend({},e.TextboxLister.defaults,t);return this.each(function(){new e.TextboxLister(this,l)})}}),e.TextboxLister=function(t,l){var o=this;return o.input=e(t),t.textboxList=o,o.opts=e.extend({},o.input.metadata(),l),o.opts.inputName||(o.opts.inputName=o.input.attr("name")),o.container=o.input.wrap("<div />").parent().addClass(o.opts.containerClass).append("<span class='foswikiClear'></span>"),o.opts.enableClose&&o.container.addClass("jqTextboxListEnableClose"),o.opts.clearControl&&e(o.opts.clearControl).click(function(){return o.clear(),this.blur(),!1}),o.opts.resetControl&&e(o.opts.resetControl).click(function(){return o.reset(),this.blur(),!1}),o.opts.autocomplete?(e.extend(o.opts,{source:o.opts.autocomplete,select:function(t,l){return e.log("TEXTBOXLIST: selected value="+l.item.value+" label="+l.item.label),o.select(l.item.value),!1}}),o.input.attr("autocomplete","off").autocomplete(o.opts)):e.log("TEXTBOXLIST: no autocomplete"),o.input.bind("keydown.textboxlist",function(t){if(13==t.keyCode){var l=o.input.val();if(l)return e.log("TEXTBOXLIST: closing suggestion list"),o.opts.autocomplete&&o.input.autocomplete("close"),o.select(l),t.preventDefault(),!1}}),o.input.bind("AddValue",function(t,l){e.log("TEXTBOXLIST: got add event, val="+l),l&&o.select(l)}),o.input.bind("DeleteValue",function(e,t){t&&o.deselect([t])}),o.input.bind("Reset",function(e){o.reset()}),o.input.bind("Clear",function(e){o.clear()}),o.currentValues=[],o.titleOfValue=[],o.input.val()&&o.select(o.input.val().split(/\s*,\s*/).sort(),!0),o.initialValues=o.currentValues.slice(),o.input.removeClass("foswikiHidden").show(),this},e.TextboxLister.prototype.clear=function(){e.log("TEXTBOXLIST: called clear");this.container.find("."+this.opts.listValueClass).remove(),this.currentValues=[],this.titleOfValue=[],"function"==typeof this.opts.onClear&&(e.log("TEXTBOXLIST: calling onClear handler"),this.opts.onClear(this))},e.TextboxLister.prototype.reset=function(){e.log("TEXTBOXLIST: called reset");this.clear(),this.select(this.initialValues),"function"==typeof this.opts.onReset&&(e.log("TEXTBOXLIST: calling onReseet handler"),this.opts.onReset(this))},e.TextboxLister.prototype.select=function(t,l){e.log("TEXTBOXLIST: called select("+t+") "+typeof t);var o,n,s,i,a,r,u,c,p=this;for("object"==typeof t&&(t=t.join(",")),t=void 0!==t&&"null"!=typeof t?t.split(/\s*,\s*/).sort():"",o=0;o<t.length;o++)a=!1,(s=t[o])&&(i=s,s.match(/^(.*)=(.*)$/)&&(t[o]=s=RegExp.$1,p.titleOfValue["_"+s]=RegExp.$2));if(p.currentValues.length>0){for(o=0;o<t.length;o++)if(s=t[o],a=!1,s){for(n=0;n<p.currentValues.length;n++)if(p.currentValues[n]==s){a=!0;break}a||p.currentValues.push(s)}}else for(p.currentValues=[],o=0;o<t.length;o++)(s=t[o])&&p.currentValues.push(s);for(p.opts.doSort&&(p.currentValues=p.currentValues.sort()),e.log("TEXTBOXLIST: self.currentValues="+p.currentValues+" length="+p.currentValues.length),p.container.find("."+p.opts.listValueClass).remove(),o=p.currentValues.length-1;o>=0;o--)(s=p.currentValues[o])&&(i=p.titleOfValue["_"+s]||s,e.log("TEXTBOXLIST: val="+s+" title="+i),c="tag_"+i.replace(/["' ]/,"_"),r="<input type='hidden' name='"+p.opts.inputName+"' value='"+s+"' title='"+i+"' />",p.opts.enableClose&&(u=e("<a href='#' title='remove "+i+"'></a>").addClass(p.opts.closeClass).click(function(t){return t.preventDefault(),p.input.trigger("DeleteValue",e(this).parent().find("input").val()),!1})),e("<span></span>").addClass(p.opts.listValueClass+" "+c).append(r).append(u).append(i).prependTo(p.container));p.input.val(""),l||"function"!=typeof p.opts.onSelect||(e.log("TEXTBOXLIST: calling onSelect handler"),p.opts.onSelect(p)),p.input.trigger("SelectedValue",t)},e.TextboxLister.prototype.deselect=function(t){e.log("TEXTBOXLIST: called deselect("+t+")");var l,o,n,s,i,a=[];if("object"==typeof t&&(t=t.join(",")),(t=t.split(/\s*,\s*/)).length){for(l=0;l<this.currentValues.length;l++)if(n=this.currentValues[l]){for(s=!1,o=0;o<t.length;o++)if((i=t[o])&&n==i){s=!0;break}!s&&n&&a.push(n)}this.currentValues=a,"function"==typeof this.opts.onDeselect&&(e.log("TEXTBOXLIST: calling onDeselect handler"),this.opts.onDeselect(this)),this.select(a,!0)}},e.TextboxLister.defaults={containerClass:"jqTextboxListContainer",listValueClass:"jqTextboxListValue",closeClass:"jqTextboxListClose",enableClose:!0,doSort:!1,inputName:void 0,resetControl:void 0,clearControl:void 0,autocomplete:void 0,onClear:void 0,onReset:void 0,onSelect:void 0,onDeselect:void 0}}(jQuery);
